import { describe, test, expect, beforeEach, vi } from "vitest";
import { POST } from "@/app/api/upload/image/route";
import { db } from "@/lib/db";
import {
  createAuthenticatedSession,
  mockUnauthenticatedSession,
  generateUniqueId,
  createPostRequest,
  getMockedSession,
} from "@/__tests__/support/helpers";
import { createTestFeature } from "@/__tests__/support/fixtures/feature";

// Create mock S3 service methods
const mockS3Service = {
  validateFileType: vi.fn(),
  validateFileSize: vi.fn(),
  validateImageBuffer: vi.fn(),
  generateS3Path: vi.fn(),
  generatePresignedUploadUrl: vi.fn(),
};

// Mock S3 service to avoid AWS SDK calls
vi.mock("@/services/s3", () => ({
  getS3Service: vi.fn(() => mockS3Service),
}));

// Mock NextAuth
vi.mock("next-auth/next", () => ({
  getServerSession: vi.fn(),
}));

vi.mock("@/lib/auth/nextauth", () => ({
  authOptions: {},
}));

describe("POST /api/upload/image Integration Tests", () => {
  async function createTestUserWithWorkspaceAndTask() {
    return await db.$transaction(async (tx) => {
      const testUser = await tx.user.create({
        data: {
          id: generateUniqueId("test-user"),
          email: `test-${generateUniqueId()}@example.com`,
          name: "Test User",
        },
      });

      const testWorkspace = await tx.workspace.create({
        data: {
          id: generateUniqueId("workspace"),
          name: "Test Workspace",
          slug: generateUniqueId("test-workspace"),
          description: "Test workspace description",
          ownerId: testUser.id,
        },
      });

      const testSwarm = await tx.swarm.create({
        data: {
          swarmId: `swarm-${Date.now()}`,
          name: `test-swarm-${Date.now()}`,
          status: "ACTIVE",
          instanceType: "XL",
          swarmApiKey: "test-api-key",
          swarmUrl: "https://test-swarm.com/api",
          swarmSecretAlias: "test-secret",
          poolName: "test-pool",
          environmentVariables: [],
          services: [],
          workspaceId: testWorkspace.id,
          agentRequestId: null,
          agentStatus: null,
        },
      });

      const testTask = await tx.task.create({
        data: {
          id: generateUniqueId("task"),
          title: "Test Task",
          description: "Test task description",
          status: "TODO",
          workspaceId: testWorkspace.id,
          workflowStatus: WorkflowStatus.PENDING,
          createdById: testUser.id,
          updatedById: testUser.id,
        },
      });

      return { testUser, testWorkspace, testSwarm, testTask };
    });
  }

  // Helper to create test image buffers with proper magic numbers
  function createJpegBuffer(): string {
    const buffer = Buffer.from([
      0xff, 0xd8, 0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01,
      0x01, 0x00, 0x00, 0x01,
    ]);
    return buffer.toString("base64");
  }

  function createPngBuffer(): string {
    const buffer = Buffer.from([
      0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d,
      0x49, 0x48, 0x44, 0x52,
    ]);
    return buffer.toString("base64");
  }

  function createGifBuffer(): string {
    const buffer = Buffer.from([
      0x47, 0x49, 0x46, 0x38, 0x39, 0x61, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
      0x00, 0x21, 0xf9, 0x04,
    ]);
    return buffer.toString("base64");
  }

  function createWebpBuffer(): string {
    const buffer = Buffer.from([
      0x52, 0x49, 0x46, 0x46, 0x24, 0x00, 0x00, 0x00, 0x57, 0x45, 0x42, 0x50,
      0x56, 0x50, 0x38, 0x20,
    ]);
    return buffer.toString("base64");
  }

  function createInvalidBuffer(): string {
    const buffer = Buffer.from([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]);
    return buffer.toString("base64");
  }

  beforeEach(async () => {
    vi.clearAllMocks();
  });

  describe("Authentication Tests", () => {
    test("should return 401 for unauthenticated request", async () => {
      getMockedSession().mockResolvedValue(mockUnauthenticatedSession());

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: "test-task-id",
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(401);
      const data = await response.json();
      expect(data.error).toBe("Authentication required");
      expect(mockS3Service.generatePresignedUploadUrl).not.toHaveBeenCalled();
    });

    test("should return 401 for session without user", async () => {
      getMockedSession().mockResolvedValue({
        user: null,
      });

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: "test-task-id",
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(401);
      expect(await response.json()).toEqual({ error: "Authentication required" });
    });
  });

  describe("Input Validation Tests", () => {
    test("should return 400 for missing filename", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        // filename missing
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
      expect(data.details).toBeDefined();
    });

    test("should return 400 for missing contentType", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        // contentType missing
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
      expect(data.details).toBeDefined();
    });

    test("should return 400 for missing size", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        // size missing
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
      expect(data.details).toBeDefined();
    });

    test("should return 400 for missing taskId", async () => {
      const { testUser } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        // taskId missing
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
      expect(data.details).toBeDefined();
    });

    test("should return 400 for invalid size (negative)", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: -1, // Invalid negative size
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
    });

    test("should return 400 for zero byte file size", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "empty.jpg",
        contentType: "image/jpeg",
        size: 0, // Zero bytes
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
    });

    test("should return 400 for empty filename string", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "", // Empty string
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toBe("Invalid request data");
    });
  });

  describe("Database Access Control Tests", () => {
    test("should return 404 for non-existent task", async () => {
      const { testUser } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: "non-existent-task-id",
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(404);
      expect(await response.json()).toEqual({ error: "Task not found" });
    });

    test("should return 404 for deleted task", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();

      // Mark task as deleted
      await db.task.update({
        where: { id: testTask.id },
        data: { deleted: true, deletedAt: new Date() },
      });

      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(404);
      expect(await response.json()).toEqual({ error: "Task not found" });
    });
  });

  describe("File Security Tests - MIME Type Validation", () => {
    test("should reject non-image MIME type (PDF)", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to reject PDF
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(false);

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "document.pdf",
        contentType: "application/pdf",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toContain("Invalid file type");
      expect(mockS3Service.validateFileType).toHaveBeenCalledWith("application/pdf");
    });

    test("should reject executable MIME type (JavaScript)", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to reject JavaScript
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(false);

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "malicious.js",
        contentType: "application/javascript",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toContain("Invalid file type");
      expect(mockS3Service.validateFileType).toHaveBeenCalledWith("application/javascript");
    });

    test("should accept valid image types (JPEG, PNG, GIF, WebP)", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to accept image
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_test.jpg",
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const imageTypes = [
        { contentType: "image/jpeg", filename: "test.jpg" },
        { contentType: "image/png", filename: "test.png" },
        { contentType: "image/gif", filename: "test.gif" },
        { contentType: "image/webp", filename: "test.webp" },
      ];

      for (const { contentType, filename } of imageTypes) {
        const request = createPostRequest("http://localhost:3000/api/upload/image", {
          taskId: testTask.id,
          filename,
          contentType,
          size: 1024000,
        });

        const response = await POST(request);

        expect(response.status).toBe(200);
        expect(mockS3Service.validateFileType).toHaveBeenCalledWith(contentType);
      }
    });
  });

  describe("File Security Tests - Magic Number Validation", () => {
    test("should validate JPEG magic numbers correctly", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
        buffer: createJpegBuffer(),
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateImageBuffer).toHaveBeenCalledWith(
        expect.any(Buffer),
        "image/jpeg",
      );
    });

    test("should validate PNG magic numbers correctly", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.png",
        contentType: "image/png",
        size: 1024000,
        buffer: createPngBuffer(),
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateImageBuffer).toHaveBeenCalledWith(
        expect.any(Buffer),
        "image/png",
      );
    });

    test("should validate GIF magic numbers correctly", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.gif",
        contentType: "image/gif",
        size: 1024000,
        buffer: createGifBuffer(),
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateImageBuffer).toHaveBeenCalledWith(
        expect.any(Buffer),
        "image/gif",
      );
    });

    test("should validate WebP magic numbers correctly", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.webp",
        contentType: "image/webp",
        size: 1024000,
        buffer: createWebpBuffer(),
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateImageBuffer).toHaveBeenCalledWith(
        expect.any(Buffer),
        "image/webp",
      );
    });

    test("should reject invalid magic numbers", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to reject invalid magic numbers
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(false);

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "fake.jpg",
        contentType: "image/jpeg",
        size: 1024000,
        buffer: createInvalidBuffer(),
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toContain("Invalid image content");
      expect(data.error).toContain("Magic number validation failed");
    });

    test("should reject JPEG magic numbers with PNG content type mismatch", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to reject mismatched type
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateImageBuffer).mockReturnValue(false);

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "fake.png",
        contentType: "image/png",
        size: 1024000,
        buffer: createJpegBuffer(), // JPEG buffer but claiming PNG
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toContain("Invalid image content");
    });

    test("should allow upload without buffer (skip magic number validation)", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
        // No buffer provided
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateImageBuffer).not.toHaveBeenCalled();
    });
  });

  describe("File Size Validation Tests", () => {
    test("should reject files exceeding 10MB size limit", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to accept file type but reject size
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(false);

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "large-image.jpg",
        contentType: "image/jpeg",
        size: 11 * 1024 * 1024, // 11MB
      });

      const response = await POST(request);

      expect(response.status).toBe(400);
      const data = await response.json();
      expect(data.error).toContain("File size exceeds maximum limit");
      expect(mockS3Service.validateFileSize).toHaveBeenCalledWith(11 * 1024 * 1024);
    });

    test("should accept file exactly at 10MB limit", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "max-size.jpg",
        contentType: "image/jpeg",
        size: 10 * 1024 * 1024, // Exactly 10MB
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.validateFileSize).toHaveBeenCalledWith(10 * 1024 * 1024);
    });
  });

  describe("Path Generation Tests", () => {
    test("should generate S3 path with correct hierarchy", async () => {
      const { testUser, testTask, testWorkspace, testSwarm } =
        await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        `uploads/${testWorkspace.id}/${testSwarm.id}/${testTask.id}/1234567890_abc123_test.jpg`,
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.generateS3Path).toHaveBeenCalledWith(
        testWorkspace.id,
        testSwarm.id,
        testTask.id,
        "test.jpg",
      );

      const data = await response.json();
      expect(data.s3Path).toContain(testWorkspace.id);
      expect(data.s3Path).toContain(testSwarm.id);
      expect(data.s3Path).toContain(testTask.id);
    });

    test("should sanitize filename with special characters", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_file_with_special_chars.jpg",
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "file with spaces & special!chars@.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.generateS3Path).toHaveBeenCalledWith(
        expect.any(String),
        expect.any(String),
        testTask.id,
        "file with spaces & special!chars@.jpg",
      );
    });

    test("should use default swarmId when swarm is not configured", async () => {
      const testUser = await db.user.create({
        data: {
          id: generateUniqueId("test-user"),
          email: `test-${generateUniqueId()}@example.com`,
          name: "Test User",
        },
      });

      const testWorkspace = await db.workspace.create({
        data: {
          id: generateUniqueId("workspace"),
          name: "Test Workspace",
          slug: generateUniqueId("test-workspace"),
          description: "Test workspace without swarm",
          ownerId: testUser.id,
        },
      });

      const testTask = await db.task.create({
        data: {
          id: generateUniqueId("task"),
          title: "Test Task",
          description: "Test task description",
          status: "TODO",
          workspaceId: testWorkspace.id,
          workflowStatus: WorkflowStatus.PENDING,
          createdById: testUser.id,
          updatedById: testUser.id,
        },
      });

      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        `uploads/${testWorkspace.id}/default/${testTask.id}/1234567890_abc123_test.jpg`,
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.generateS3Path).toHaveBeenCalledWith(
        testWorkspace.id,
        "default", // Default swarmId when no swarm configured
        testTask.id,
        "test.jpg",
      );
    });
  });

  describe("Presigned URL Properties Tests", () => {
    test("should generate presigned URL with correct parameters", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_test.jpg",
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url?signature=abc123",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.generatePresignedUploadUrl).toHaveBeenCalledWith(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_test.jpg",
        "image/jpeg",
        300, // 5 minutes expiration
      );

      const data = await response.json();
      expect(data.presignedUrl).toBe(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url?signature=abc123",
      );
    });

    test("should include correct Content-Type in presigned URL generation", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const contentTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];

      for (const contentType of contentTypes) {
        const request = createPostRequest("http://localhost:3000/api/upload/image", {
          taskId: testTask.id,
          filename: "test.jpg",
          contentType,
          size: 1024000,
        });

        await POST(request);

        expect(mockS3Service.generatePresignedUploadUrl).toHaveBeenCalledWith(
          expect.any(String),
          contentType,
          300,
        );
      }
    });

    test("should return complete response with all required fields", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_image.png",
      );
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url?X-Amz-Signature=abc123",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "image.png",
        contentType: "image/png",
        size: 2048000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      const data = await response.json();

      // Verify all required response fields
      expect(data).toHaveProperty("presignedUrl");
      expect(data).toHaveProperty("s3Path");
      expect(data).toHaveProperty("filename");
      expect(data).toHaveProperty("contentType");
      expect(data).toHaveProperty("size");

      expect(data.presignedUrl).toBe(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url?X-Amz-Signature=abc123",
      );
      expect(data.s3Path).toBe(
        "uploads/workspace123/swarm456/task789/1234567890_abc123_image.png",
      );
      expect(data.filename).toBe("image.png");
      expect(data.contentType).toBe("image/png");
      expect(data.size).toBe(2048000);
    });
  });

  describe("Error Handling Tests", () => {
    test("should handle S3 service failure gracefully", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service to pass validation but fail on URL generation
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockRejectedValue(
        new Error("AWS SDK Error: Invalid credentials"),
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(500);
      const data = await response.json();
      expect(data.error).toBe("Internal server error");
    });

    test("should handle database errors gracefully", async () => {
      const { testUser } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Use malformed task ID to trigger database error
      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: "malformed-task-id-that-causes-db-error",
        filename: "test.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      // Should return 404 for task not found (database query returns null)
      expect(response.status).toBe(404);
      expect(await response.json()).toEqual({ error: "Task not found" });
    });
  });

  describe("Edge Cases", () => {
    test("should handle very long filename", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const longFilename = "a".repeat(500) + ".jpg"; // 500+ character filename

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: longFilename,
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
      expect(mockS3Service.generateS3Path).toHaveBeenCalledWith(
        expect.any(String),
        expect.any(String),
        testTask.id,
        longFilename,
      );
    });

    test("should handle unicode characters in filename", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url",
      );

      const request = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "测试图片.jpg", // Chinese characters
        contentType: "image/jpeg",
        size: 1024000,
      });

      const response = await POST(request);

      expect(response.status).toBe(200);
    });

    test("should handle concurrent upload requests", async () => {
      const { testUser, testTask } = await createTestUserWithWorkspaceAndTask();
      getMockedSession().mockResolvedValue(createAuthenticatedSession(testUser));

      // Mock S3Service
      vi.mocked(mockS3Service.validateFileType).mockReturnValue(true);
      vi.mocked(mockS3Service.validateFileSize).mockReturnValue(true);
      vi.mocked(mockS3Service.generateS3Path).mockReturnValue("test-path-unique");
      vi.mocked(mockS3Service.generatePresignedUploadUrl).mockResolvedValue(
        "https://test-bucket.s3.us-east-1.amazonaws.com/presigned-url-unique",
      );

      const request1 = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "concurrent1.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const request2 = createPostRequest("http://localhost:3000/api/upload/image", {
        taskId: testTask.id,
        filename: "concurrent2.jpg",
        contentType: "image/jpeg",
        size: 1024000,
      });

      const [response1, response2] = await Promise.all([POST(request1), POST(request2)]);

      expect(response1.status).toBe(200);
      expect(response2.status).toBe(200);
    });
  });
});