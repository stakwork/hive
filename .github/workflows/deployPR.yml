name: Deploy PR Preview

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  Deploy-Preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      ############################################################
      # 1️⃣ Select Rotating Preview Slot
      ############################################################

      - name: Select Preview Slot
        id: slot
        run: |
          URLS=(
            "preview-1.yourdomain.com"
            "preview-2.yourdomain.com"
            "preview-3.yourdomain.com"
          )

          INDEX=$((${{ github.event.pull_request.number }} % ${#URLS[@]}))
          echo "preview_url=${URLS[$INDEX]}" >> $GITHUB_OUTPUT

      ############################################################
      # 2️⃣ Create Neon Temporary Branch
      ############################################################

      - name: Create Neon Branch
        id: neon
        run: |
          BRANCH_NAME="pr-${{ github.event.pull_request.number }}"

          RESPONSE=$(curl -s -X POST "https://console.neon.tech/api/v2/projects/$NEON_PROJECT_ID/branches" \
            -H "Authorization: Bearer $NEON_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"branch\": {
                \"name\": \"$BRANCH_NAME\",
                \"expires_at\": \"$(date -u -d '+1 day' +%Y-%m-%dT%H:%M:%SZ')\"
              }
            }")

          echo "$RESPONSE"

          DB_HOST=$(echo $RESPONSE | jq -r '.branch.endpoints[0].host')
          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT

      ############################################################
      # 3️⃣ Create GitHub Deployment
      ############################################################

      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: `preview-${{ github.event.pull_request.number }}`,
              auto_merge: false,
              required_contexts: [],
              description: 'PR preview deployment'
            });
            return deployment.data.id;

      ############################################################
      # 4️⃣ Setup Node + Vercel
      ############################################################

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install --global vercel@latest

      - run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      ############################################################
      # 5️⃣ Inject Neon DB into Build
      ############################################################

      - name: Create .env for Preview
        run: |
          echo "DATABASE_URL=postgres://${{ secrets.NEON_DB_USER }}:${{ secrets.NEON_DB_PASS }}@${{ steps.neon.outputs.db_host }}/neondb?sslmode=require" >> .env

      ############################################################
      # 6️⃣ Build + Deploy
      ############################################################

      - name: Build
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy \
            --prebuilt \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --env DATABASE_URL=$DATABASE_URL \
            --alias ${{ steps.slot.outputs.preview_url }}
          )
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      ############################################################
      # 7️⃣ Mark Deployment Success
      ############################################################

      - name: Mark Success
        if: success() && steps.deployment.outputs.result
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.deployment_url }}'
            });

      - name: Mark Failure
        if: failure() && steps.deployment.outputs.result
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'failure'
            });

